<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>3D Racing Demo (Fixed)</title>
  <style>body{margin:0;overflow:hidden;}canvas{display:block}</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
<script>
let scene = new THREE.Scene();
scene.background = new THREE.Color(0x87ceeb); // sky blue

let camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
camera.position.set(0,8,15); // start above and behind

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

// Lights
let hemi = new THREE.HemisphereLight(0xffffff,0x444444,1.0);
scene.add(hemi);
let dirLight = new THREE.DirectionalLight(0xffffff,0.8);
dirLight.position.set(20,20,10);
scene.add(dirLight);

// Track (flat gray plane)
let trackGeo = new THREE.PlaneGeometry(200,200);
let trackMat = new THREE.MeshStandardMaterial({color:0x333333});
let track = new THREE.Mesh(trackGeo,trackMat);
track.rotation.x = -Math.PI/2;
scene.add(track);

// Car (blue box)
let carGeo = new THREE.BoxGeometry(2,1,4);
let carMat = new THREE.MeshStandardMaterial({color:0x0077ff});
let car = new THREE.Mesh(carGeo,carMat);
car.position.y = 0.5;
scene.add(car);

// Chase camera offset
let camOffset = new THREE.Vector3(0,5,-12);

// Input setup
let input={steer:0,throttle:0,brake:0};
let keys={};
window.addEventListener('keydown',e=>keys[e.code]=true);
window.addEventListener('keyup',e=>keys[e.code]=false);

function pollKeyboard(){
  input.steer = (keys["ArrowLeft"]||keys["KeyA"]?-1:0) + (keys["ArrowRight"]||keys["KeyD"]?1:0);
  input.throttle = keys["ArrowUp"]||keys["KeyW"]?1:0;
  input.brake = keys["ArrowDown"]||keys["KeyS"]?1:0;
}

// Gamepad
function pollGamepad(){
  let pads=navigator.getGamepads();
  for(let gp of pads){
    if(!gp) continue;
    input.steer=gp.axes[0]||0;
    input.throttle=gp.buttons[7]?.value||0;
    input.brake=gp.buttons[6]?.value||0;
    break;
  }
}

// Mobile joystick
let joystick=nipplejs.create({zone:document.body});
joystick.on("move",(evt,data)=>{
  input.steer=data.vector.x;
  input.throttle=data.vector.y<0?-data.vector.y:0;
  input.brake=data.vector.y>0?data.vector.y:0;
});
joystick.on("end",()=>{input.steer=0;input.throttle=0;input.brake=0;});

// Simple physics
let speed=0,angle=0;
function animate(){
  requestAnimationFrame(animate);
  pollKeyboard(); pollGamepad();

  angle -= input.steer*0.03;
  speed += (input.throttle-input.brake)*0.02;
  speed*=0.98; // drag

  car.position.x += Math.sin(angle)*speed;
  car.position.z += Math.cos(angle)*speed;
  car.rotation.y = angle;

  // Chase camera
  let desired = car.position.clone().add(camOffset.clone().applyAxisAngle(new THREE.Vector3(0,1,0),angle));
  camera.position.lerp(desired,0.1);
  camera.lookAt(car.position);

  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
