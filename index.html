<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Magnificent Car Game</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #joystick-container {
      position: absolute;
      bottom: 20px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      padding: 0 20px;
      pointer-events: none;
    }
    .joystick {
      width: 120px;
      height: 120px;
      background: rgba(255,255,255,0.1);
      border: 2px solid #fff;
      border-radius: 50%;
      pointer-events: auto;
      touch-action: none;
    }
  </style>
</head>
<body>
  <div id="joystick-container">
    <div id="joystick-left" class="joystick"></div>
    <div id="joystick-right" class="joystick"></div>
  </div>
  <canvas id="gameCanvas"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script>
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x202020);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas'), antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;

    // Ground
    const groundGeo = new THREE.PlaneGeometry(200, 200);
    const groundMat = new THREE.MeshStandardMaterial({ color: 0x333333 });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Car
    const carGeo = new THREE.BoxGeometry(2, 1, 4);
    const carMat = new THREE.MeshStandardMaterial({ color: 0xff4444 });
    const car = new THREE.Mesh(carGeo, carMat);
    car.castShadow = true;
    car.position.y = 0.5;
    scene.add(car);

    // Lights
    const ambient = new THREE.AmbientLight(0xffffff, 0.4);
    scene.add(ambient);

    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(10, 20, 10);
    dirLight.castShadow = true;
    scene.add(dirLight);

    // Camera follow
    function updateCamera() {
      const offset = new THREE.Vector3(0, 5, -10).applyQuaternion(car.quaternion);
      camera.position.copy(car.position).add(offset);
      camera.lookAt(car.position);
    }

    // Joystick logic
    let leftInput = { x: 0, y: 0 };
    let rightInput = { x: 0, y: 0 };

    function setupJoystick(id, callback) {
      const el = document.getElementById(id);
      let dragging = false;
      let startX = 0, startY = 0;

      el.addEventListener('touchstart', e => {
        dragging = true;
        const touch = e.touches[0];
        startX = touch.clientX;
        startY = touch.clientY;
      });

      el.addEventListener('touchmove', e => {
        if (!dragging) return;
        const touch = e.touches[0];
        const dx = touch.clientX - startX;
        const dy = touch.clientY - startY;
        const max = 40;
        const x = Math.max(-max, Math.min(max, dx)) / max;
        const y = Math.max(-max, Math.min(max, dy)) / max;
        callback({ x, y });
      });

      el.addEventListener('touchend', () => {
        dragging = false;
        callback({ x: 0, y: 0 });
      });
    }

    setupJoystick('joystick-left', input => leftInput = input);
    setupJoystick('joystick-right', input => rightInput = input);

    // Car movement
    let velocity = 0;
    const maxSpeed = 0.2;
    const acceleration = 0.01;
    const turnSpeed = 0.03;

    function updateCar() {
      // Forward/backward
      if (leftInput.y < -0.1) velocity = Math.min(maxSpeed, velocity + acceleration);
      else if (leftInput.y > 0.1) velocity = Math.max(-maxSpeed, velocity - acceleration);
      else velocity *= 0.95; // friction

      // Turning
      if (rightInput.x > 0.1) car.rotation.y -= turnSpeed;
      else if (rightInput.x < -0.1) car.rotation.y += turnSpeed;

      // Move car
      const direction = new THREE.Vector3(0, 0, -1).applyQuaternion(car.quaternion);
      car.position.add(direction.multiplyScalar(velocity));
    }

    // Animate
    function animate() {
      requestAnimationFrame(animate);
      updateCar();
      updateCamera();
      renderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
