<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>3D Racing Game - Mobile Joystick</title>
<style>
  body { margin: 0; overflow: hidden; background: #000; }
  canvas { display: block; }
  .joystick {
    position: fixed;
    bottom: 20px;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.4);
    touch-action: none;
  }
  #joystick-left { left: 20px; }
  #joystick-right { right: 20px; }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="joystick-left" class="joystick"></div>
<div id="joystick-right" class="joystick"></div>

<script src="https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>
<script>
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('gameCanvas') });
renderer.setSize(innerWidth, innerHeight);
renderer.outputEncoding = THREE.sRGBEncoding;

// Lights
scene.add(new THREE.AmbientLight(0xffffff, 0.6));
const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
dirLight.position.set(10, 10, 10);
scene.add(dirLight);

// Physics
const world = new CANNON.World();
world.gravity.set(0, -9.82, 0);

// Ground
const groundBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
groundBody.quaternion.setFromEuler(-Math.PI/2, 0, 0);
world.addBody(groundBody);

const groundMesh = new THREE.Mesh(
  new THREE.PlaneGeometry(200,200),
  new THREE.MeshStandardMaterial({ color: 0x228B22 })
);
groundMesh.rotation.x = -Math.PI/2;
scene.add(groundMesh);

// Car physics
const carBody = new CANNON.Body({
  mass: 150,
  shape: new CANNON.Box(new CANNON.Vec3(1,0.5,2))
});
carBody.position.set(0,1,0);
world.addBody(carBody);

// Car visual (no image)
const carMesh = new THREE.Mesh(
  new THREE.BoxGeometry(2,1,4),
  new THREE.MeshStandardMaterial({ color: 0xff0000, metalness: 0.3, roughness: 0.6 })
);
scene.add(carMesh);

// Joystick control data
let joystick = { leftY: 0, rightX: 0 };

function setupJoystick(el, axis) {
  let start = null;
  el.addEventListener('touchstart', e => {
    start = { x: e.touches[0].clientX, y: e.touches[0].clientY };
  });
  el.addEventListener('touchmove', e => {
    const dx = e.touches[0].clientX - start.x;
    const dy = e.touches[0].clientY - start.y;
    if (axis === 'left') joystick.leftY = -dy / 50;
    if (axis === 'right') joystick.rightX = dx / 50;
  });
  el.addEventListener('touchend', () => {
    if (axis === 'left') joystick.leftY = 0;
    if (axis === 'right') joystick.rightX = 0;
  });
}
setupJoystick(document.getElementById('joystick-left'), 'left');
setupJoystick(document.getElementById('joystick-right'), 'right');

// Movement
function updateControls() {
  if (Math.abs(joystick.leftY) > 0.1) {
    carBody.applyForce(new CANNON.Vec3(0, 0, -500 * joystick.leftY), carBody.position);
  }
  carBody.angularVelocity.y -= joystick.rightX * 0.05;
}

// Camera follow
function updateCamera() {
  camera.position.set(carBody.position.x - 6, carBody.position.y + 3, carBody.position.z + 6);
  camera.lookAt(carBody.position);
}

// Game loop
function animate() {
  requestAnimationFrame(animate);
  world.step(1/60);
  updateControls();
  carMesh.position.copy(carBody.position);
  carMesh.quaternion.copy(carBody.quaternion);
  updateCamera();
  renderer.render(scene, camera);
}
animate();
</script>
</body>
</html>
